<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Beyblade Neon</title>
<style>
  :root{
    --bg:#0a0c10; --panel:#0e121a; --ink:#e9f0ff; --muted:#a7b0c8;
    --p1:#33d6ff; --p2:#ff6b6b;
    --hp1:#2ecc71; --hp2:#ff4a6e;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% -10%,#101523,#07090d),var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  canvas{position:fixed;inset:0;width:100vw;height:100vh;touch-action:none;pointer-events:none;z-index:1;display:block}
  .hud{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;z-index:5}
  .top{display:flex;gap:.75rem;justify-content:space-between;align-items:center;padding:.75rem 1rem}
  .badge{display:flex;align-items:center;gap:.5rem;background:rgba(15,20,32,.7);border:1px solid #1e2740;border-radius:999px;padding:.45rem .7rem;backdrop-filter:blur(6px)}
  .meter{--c:#2ecc71;height:10px;width:min(36vw,240px);background:#0b1020;border:1px solid #283153;border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,var(--c),transparent);box-shadow:0 0 10px var(--c);transition:width .12s}
  .score{font-weight:800;letter-spacing:.3px;min-width:80px;text-align:right}
  .score.small{font-size:.85rem;opacity:.9;min-width:auto}
  .center{display:grid;place-items:center}
  .card{width:min(520px,92vw);padding:18px;border-radius:16px;border:1px solid #232a45;background:linear-gradient(180deg,rgba(14,18,26,.9),rgba(10,12,16,.9));box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .title{margin:.2rem 0 0;font-size:1.7rem;font-weight:900;letter-spacing:.4px;text-align:center}
  .muted{margin:.25rem 0 .5rem;color:var(--muted);text-align:center}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:10px}
  button{appearance:none;border:1px solid #2a3358;background:#11162a;color:var(--ink);padding:.9rem 1.1rem;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .06s ease, box-shadow .2s, border-color .2s;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  button:hover{transform:translateY(-1px)} button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#00e7ff,#33b6ff);color:#051018;border-color:#00e7ff;box-shadow:0 0 20px rgba(0,231,255,.35), inset 0 0 10px rgba(255,255,255,.2)}
  .ghost{background:#0e1426}
  .bottom{display:flex;justify-content:center;padding:.75rem}
  .mobile{display:none;gap:.5rem}
  @media (max-width:780px){ .mobile{display:flex} .meter{width:40vw} }
  .fab{position:fixed;right:12px;bottom:12px;z-index:6}
  .overlay{position:fixed;left:0;right:0;top:0;display:none;z-index:10;pointer-events:none;color:#fff;text-shadow:0 0 18px rgba(0,231,255,.6), 0 0 28px rgba(138,43,255,.5);font-weight:900;padding:12px 16px;text-align:left}
  .overlay .big{font-size:min(16vw,120px);letter-spacing:.02em;line-height:1}
  .overlay .small{font-size:min(4.5vw,22px);opacity:.9}
  .legend{position:fixed;left:10px;bottom:10px;font-size:12px;color:#9fb0ff;opacity:.8}
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:56px;z-index:12;color:#fff;font-weight:800;text-shadow:0 0 10px rgba(0,231,255,.5)}
</style>
</head>
<body>
  <canvas id="game"></canvas>

  <div class="hud">
    <div class="top">
      <div class="badge">
        <strong>P1</strong>
        <div class="meter"><div id="m1" class="fill" style="--c:var(--hp1);width:100%"></div></div>
        <span id="hp1" class="score">HP 100</span>
        <span id="boost1" class="score small">Boost: listo</span>
      </div>
      <div class="badge">
        <strong id="cpuLabel">CPU</strong>
        <div class="meter"><div id="m2" class="fill" style="--c:var(--hp2);width:100%"></div></div>
        <span id="hp2" class="score">HP 100</span>
        <span id="boost2" class="score small">Boost: listo</span>
      </div>
    </div>

    <div class="center">
      <div id="menu" class="card">
        <h1 class="title">BEYBLADE NEON</h1>
        <div class="muted">
          Apunta con <b>A/D</b> o ‚óÄ‚ñ∂. En <b>GO!</b> presiona <b>Espacio</b> (o <b>Shift</b> en P2) para lanzar (misma potencia).<br/>
          Boost dirigido con <b>W/A/S/D</b> cada <b>0,75s</b>.
        </div>
        <div class="row">
          <button id="btnP1" class="primary" type="button">Jugar (P1 vs CPU)</button>
          <button id="btn2P" class="ghost"   type="button">2 Jugadores</button>
        </div>
      </div>
    </div>

    <div class="bottom">
      <div class="mobile">
        <button id="btnLeft"  type="button">‚óÄ</button>
        <button id="btnPower" type="button" class="primary">CARGAR</button>
        <button id="btnRight" type="button">‚ñ∂</button>
      </div>
    </div>
  </div>

  <div class="fab">
    <button id="btnRestart" type="button">‚Üª Reiniciar</button>
  </div>

  <div id="count" class="overlay">
    <div id="countBig" class="big">3</div>
    <div id="countSmall" class="small">prep√°rate‚Ä¶</div>
  </div>

  <div class="legend">√çtems: üõ°Ô∏è Escudo ‚îÉ ü¶ç Gigante ‚îÉ üí• Da√±o+ ‚îÉ ‚ö° RPM+</div>
  <div id="toast" class="toast" style="display:none"></div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');

  // HUD (sin depender de globals por id)
  const hud = {
    m1: document.getElementById('m1'),
    m2: document.getElementById('m2'),
    hp1: document.getElementById('hp1'),
    hp2: document.getElementById('hp2'),
    boost1: document.getElementById('boost1'),
    boost2: document.getElementById('boost2'),
    menu: document.getElementById('menu'),
    btnP1: document.getElementById('btnP1'),
    btn2P: document.getElementById('btn2P'),
    btnRestart: document.getElementById('btnRestart'),
    btnL: document.getElementById('btnLeft'),
    btnR: document.getElementById('btnRight'),
    btnP: document.getElementById('btnPower'),
    cpuLabel: document.getElementById('cpuLabel'),
    overlay: document.getElementById('count'),
    countBig: document.getElementById('countBig'),
    countSmall: document.getElementById('countSmall'),
    toast: document.getElementById('toast')
  };

  // Canvas
  let W=0,H=0,DPR=1;
  function resize(){ DPR=Math.min(2,window.devicePixelRatio||1); W=cvs.width=Math.floor(innerWidth*DPR); H=cvs.height=Math.floor(innerHeight*DPR); }
  resize(); addEventListener('resize', resize);

  // Arena
  const arena={cx:0,cy:0,r:0,innerR:0};
  function setupArena(){ arena.cx=W/2; arena.cy=H/2; arena.r=Math.min(W,H)*0.40; arena.innerR=arena.r*0.94; }

  // Utils
  const TAU=Math.PI*2, clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);

  // Toast
  let toastT=0;
  function showToast(msg){ toastT=2.0; hud.toast.textContent=msg; hud.toast.style.display='block'; }
  function stepToast(dt){ if(toastT>0){ toastT-=dt; if(toastT<=0) hud.toast.style.display='none'; } }

  // Chispas
  const sparks=[];
  function spawnSparks(x,y, n=12, hue=35){
    for(let i=0;i<n;i++){
      sparks.push({x,y,vx:Math.cos(rand(0,TAU))*rand(2,6),vy:Math.sin(rand(0,TAU))*rand(2,6),life:rand(12,24),t:0,hue:hue+rand(-10,10)});
    }
  }
  function drawSparks(dt){
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i]; s.t+=dt*60;
      if(s.t>s.life){ sparks.splice(i,1); continue; }
      s.x+=s.vx*dt*60; s.y+=s.vy*dt*60; s.vy+=0.02*dt*60;
      const a = 1 - s.t/s.life, r = 3 + (1-a)*3;
      ctx.fillStyle=`hsla(${s.hue},100%,60%,${a})`;
      ctx.beginPath(); ctx.arc(s.x,s.y,r,0,TAU); ctx.fill();
      ctx.fillStyle=`rgba(255,255,255,${a*0.8})`;
      ctx.beginPath(); ctx.arc(s.x,s.y, r*0.4,0,TAU); ctx.fill();
    }
    ctx.restore();
  }

  // √çtems
  const items=[]; const ITEM_TYPES=['shield','giant','damage','rpm'];
  function spawnItem(){
    if(items.length>=3) return;
    let r = rand(arena.innerR*0.2, arena.innerR*0.9), a = rand(0,TAU);
    items.push({x:arena.cx+Math.cos(a)*r, y:arena.cy+Math.sin(a)*r, type:ITEM_TYPES[Math.floor(Math.random()*ITEM_TYPES.length)], r:18, ttl:20});
  }
  function drawItems(dt){
    for(let i=items.length-1;i>=0;i--){
      const it=items[i]; it.ttl-=dt; if(it.ttl<=0){ items.splice(i,1); continue; }
      let color='#fff', emoji='?';
      if(it.type==='shield'){ color='#4cd1ff'; emoji='üõ°Ô∏è'; }
      if(it.type==='giant'){  color='#ff9f1c'; emoji='ü¶ç'; }
      if(it.type==='damage'){ color='#ff4a6e'; emoji='üí•'; }
      if(it.type==='rpm'){    color='#82ff6a'; emoji='‚ö°'; }
      ctx.save();
      ctx.shadowColor=color; ctx.shadowBlur=15;
      ctx.fillStyle=color; ctx.globalAlpha=0.15 + 0.85*(Math.sin(performance.now()/200)+1)/2*0.3;
      ctx.beginPath(); ctx.arc(it.x,it.y,it.r,0,TAU); ctx.fill();
      ctx.shadowBlur=0; ctx.globalAlpha=1;
      ctx.font = `${Math.floor(it.r*1.3)}px system-ui, emoji`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(emoji, it.x, it.y+1);
      ctx.restore();
    }
  }
  function tryPickup(b){
    for(let i=items.length-1;i>=0;i--){
      const it=items[i], d=Math.hypot(b.x-it.x,b.y-it.y);
      if(d < b.radius + it.r){
        if(it.type==='shield'){ b.shield=Math.max(b.shield,6); showToast('üõ°Ô∏è Escudo'); }
        if(it.type==='giant'){  b.giant =Math.max(b.giant ,6); showToast('ü¶ç Gigante'); }
        if(it.type==='damage'){ b.dmg   =Math.max(b.dmg  ,6); showToast('üí• Da√±o+'); }
        if(it.type==='rpm'){    b.spinRPM=Math.min(b.maxRPM*1.05, b.spinRPM+700); showToast('‚ö° RPM+'); }
        spawnSparks(it.x,it.y,24, it.type==='rpm'? rand(80,140) : (it.type==='shield'? rand(180,220) : 30));
        items.splice(i,1);
      }
    }
  }

  // Sprites ligeros
  function makeBladeSprite(radius, baseColor, accentColor){
    const size = Math.ceil(radius*2.4);
    const c = document.createElement('canvas');
    c.width=c.height=size;
    const g = c.getContext('2d');
    g.translate(size/2,size/2);
    const r = radius;

    const grad = g.createRadialGradient(0,0,r*0.2, 0,0,r);
    grad.addColorStop(0, '#aab6c8');
    grad.addColorStop(0.45, '#62708a');
    grad.addColorStop(1, '#1a2230');
    g.fillStyle=grad; g.beginPath(); g.arc(0,0,r,0,TAU); g.fill();

    g.save();
    g.fillStyle = accentColor;
    for(let i=0;i<9;i++){
      g.rotate(TAU/9);
      g.beginPath();
      g.moveTo(r*0.78,0);
      g.lineTo(r*1.05, r*0.12);
      g.lineTo(r*0.92,-r*0.12);
      g.closePath(); g.fill();
    }
    g.restore();

    g.lineWidth = 6;
    g.strokeStyle = 'rgba(255,255,255,.25)';
    g.beginPath(); g.arc(0,0,r*0.82,0,TAU); g.stroke();

    g.save();
    g.fillStyle = baseColor;
    for(let i=0;i<3;i++){
      g.rotate(TAU/3);
      g.beginPath();
      g.moveTo(r*0.36,0);
      g.quadraticCurveTo(r*0.9,r*0.22, r*0.72,-r*0.18);
      g.lineTo(r*0.9,0);
      g.closePath(); g.fill();
    }
    g.restore();

    const coreGrad = g.createRadialGradient(-r*0.1,-r*0.1,r*0.1, 0,0, r*0.46);
    coreGrad.addColorStop(0,'#0f1320');
    coreGrad.addColorStop(1,'#0a0e18');
    g.fillStyle=coreGrad; g.beginPath(); g.arc(0,0,r*0.46,0,TAU); g.fill();

    g.fillStyle='#9db3d6';
    for(let i=0;i<6;i++){
      const a=i*TAU/6;
      g.beginPath(); g.arc(Math.cos(a)*r*0.62, Math.sin(a)*r*0.62, 3, 0, TAU); g.fill();
    }

    g.globalAlpha = .22;
    g.fillStyle = '#ffffff';
    g.beginPath();
    g.ellipse(-r*0.25,-r*0.15, r*0.9, r*0.32, -0.7, 0, TAU);
    g.fill();
    g.globalAlpha = 1;

    const halo = g.createRadialGradient(0,0, r*0.9, 0,0, r*1.18);
    halo.addColorStop(0,'rgba(0,0,0,0)');
    halo.addColorStop(1,'rgba(255,255,255,0.08)');
    g.fillStyle=halo; g.beginPath(); g.arc(0,0,r*1.18,0,TAU); g.fill();

    return c;
  }

  class Blade{
    constructor(o){Object.assign(this,{
      x:0,y:0,vx:0,vy:0,ang:0,
      spinRPM:0,maxRPM:4500,
      hp:100,maxHP:100,
      baseRadius:28,radius:28,mass:1,color:'#fff',accent:'#88aaff',name:'Blade',
      hasLaunched:false,launching:true,alive:true,ringOut:false,
      shield:0, giant:0, dmg:0,
      boostCD:0,
      sprite:null
    },o);}
    ensureSprite(){ if(!this.sprite){ this.sprite = makeBladeSprite(this.baseRadius, this.color, this.accent); } }
    fairLaunch(angle){
      const fixedSpeed=8.5, fixedRPM=this.maxRPM*0.85;
      this.vx=Math.cos(angle)*fixedSpeed; this.vy=Math.sin(angle)*fixedSpeed;
      this.spinRPM=fixedRPM; this.launching=false; this.hasLaunched=true;
    }
    applyBoostDir(dx,dy){
      if(this.boostCD>0) return false;
      const m=Math.hypot(dx,dy)||1, nx=dx/m, ny=dy/m;
      const strength = 3.0;
      this.vx += nx*strength; this.vy += ny*strength;
      spawnSparks(this.x+nx*this.radius, this.y+ny*this.radius, 12, 45);
      this.boostCD = 0.75;
      return true;
    }
    takeDamage(amount){ this.hp=Math.max(0,this.hp-amount); if(this.hp<=0) this.alive=false; }
    step(dt){
      this.boostCD=Math.max(0,this.boostCD-dt);
      if(this.giant>0){ this.giant-=dt; this.radius=this.baseRadius*1.4; } else { this.radius=this.baseRadius; }
      if(this.shield>0) this.shield-=dt; if(this.dmg>0) this.dmg-=dt;
      if(this.launching || !this.alive) return;

      const k=Math.pow(1-0.65*0.001, dt*1000); this.vx*=k; this.vy*=k;
      this.x+=this.vx*dt*60; this.y+=this.vy*dt*60;
      this.ang+=(this.spinRPM/60)*TAU*dt;

      const speed=Math.hypot(this.vx,this.vy);
      const baseDecay=70, velDecay=10*speed;
      this.spinRPM=Math.max(0,this.spinRPM-(baseDecay+velDecay)*dt);

      const dx=this.x-arena.cx, dy=this.y-arena.cy, d=Math.hypot(dx,dy);
      if(d>arena.innerR-this.radius){
        const nx=dx/d, ny=dy/d, overlap=d-(arena.innerR-this.radius);
        this.x-=nx*overlap; this.y-=ny*overlap;
        const vn=this.vx*nx+this.vy*ny; this.vx-=1.6*vn*nx; this.vy-=1.6*vn*ny;
        let wallLossRPM=120, wallHP=6;
        if(this.shield>0){ wallLossRPM*=0.45; wallHP*=0.5; }
        this.spinRPM=Math.max(0,this.spinRPM-wallLossRPM);
        this.takeDamage(wallHP);
        spawnSparks(this.x,this.y,16,28);
      }
      if(d>arena.r+10){ this.alive=false; this.ringOut=true; }
      if(this.spinRPM<=60 && Math.hypot(this.vx,this.vy)<0.1){ this.alive=false; }
    }
    draw(){
      this.ensureSprite();
      const spinFactor = Math.min(1, this.spinRPM/2000);
      if(spinFactor>0.1){
        ctx.save();
        ctx.globalAlpha = 0.12*spinFactor;
        ctx.strokeStyle = this===game.p1 ? 'rgba(51,214,255,.6)' : 'rgba(255,107,107,.6)';
        ctx.lineWidth = 6;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.radius*0.9, 0, TAU); ctx.stroke();
        ctx.restore();
      }
      ctx.save();
      ctx.translate(this.x,this.y); ctx.rotate(this.ang);
      const s = this.sprite, scale = this.radius/this.baseRadius;
      ctx.drawImage(s, -s.width*0.5*scale, -s.height*0.5*scale, s.width*scale, s.height*scale);
      if(this.shield>0||this.dmg>0){
        ctx.globalAlpha=0.5; ctx.shadowBlur=18;
        ctx.shadowColor=this.shield>0?'rgba(76,209,255,.9)':'rgba(255,74,110,.9)';
        ctx.strokeStyle=ctx.shadowColor; ctx.lineWidth=3;
        ctx.beginPath(); ctx.arc(0,0,this.radius*1.15,0,TAU); ctx.stroke();
      }
      ctx.restore();

      // Barra HP sobre el beyblade
      const barW=100, barH=10, pad=this.radius+18, ratio=this.hp/this.maxHP;
      ctx.save();
      ctx.translate(this.x, this.y - pad);
      ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-barW/2, -barH/2, barW, barH);
      ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=2; ctx.strokeRect(-barW/2, -barH/2, barW, barH);
      ctx.fillStyle = (this===game.p1)? getComputedStyle(document.documentElement).getPropertyValue('--hp1') : getComputedStyle(document.documentElement).getPropertyValue('--hp2');
      ctx.fillRect(-barW/2, -barH/2, barW*ratio, barH);
      ctx.restore();
    }
  }

  const game={
    running:false,twoPlayers:false,phase:'menu', // 'countdown' | 'window' | 'battle'
    countdownLeft:0, windowLeft:0, spawnTimer:0, cpuBoostTimer:3,
    p1:new Blade({name:'P1', color:getComputedStyle(document.documentElement).getPropertyValue('--p1'), accent:'#7ad8ff'}),
    p2:new Blade({name:'CPU', color:getComputedStyle(document.documentElement).getPropertyValue('--p2'), accent:'#ffb4b4'}),
    angle1:-Math.PI/3, angle2:-2*Math.PI/3
  };

  function resetPositions(){
    game.p1.x=arena.cx - arena.r*0.45; game.p1.y=arena.cy + arena.r*0.35;
    game.p2.x=arena.cx + arena.r*0.45; game.p2.y=arena.cy + arena.r*0.35;
    for(const b of [game.p1,game.p2]){
      b.vx=b.vy=0; b.ang=0; b.spinRPM=0; b.hp=100; b.alive=true; b.ringOut=false; b.launching=true; b.hasLaunched=false;
      b.shield=0; b.giant=0; b.dmg=0; b.boostCD=0; b.radius=b.baseRadius;
      b.sprite=null; b.ensureSprite();
    }
    items.length=0; game.spawnTimer=1.5; game.cpuBoostTimer=3;
  }

  function showMenu(show){ hud.menu.style.display = show ? 'block' : 'none'; }
  function showOverlay(txt, sub){ hud.overlay.style.display='block'; hud.countBig.textContent=txt; hud.countSmall.textContent=sub||''; }
  function hideOverlay(){ hud.overlay.style.display='none'; }

  function startRound(){
    setupArena(); resetPositions(); showMenu(false);
    game.running=true; game.phase='countdown'; game.countdownLeft=3.0; game.windowLeft=0;
    showOverlay('3','prep√°rate‚Ä¶');
  }

  // Arranque
  hud.btnP1.onclick=()=>{ game.twoPlayers=false; hud.cpuLabel.textContent='CPU'; startRound(); };
  hud.btn2P.onclick=()=>{ game.twoPlayers=true;  hud.cpuLabel.textContent='P2';  startRound(); };
  hud.btnRestart.onclick=()=> startRound();

  // Controles (‚úÖ √öNICO bloque de teclas)
  const keys=new Set();
  addEventListener('keydown',e=>{
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','s','d','w','A','S','D','W',' ','r','R','Shift'].includes(e.key)) e.preventDefault();
    if(e.key==='w'||e.key==='W') game.p1.applyBoostDir(0,-1);
    if(e.key==='s'||e.key==='S') game.p1.applyBoostDir(0, 1);
    if(e.key==='a'||e.key==='A') game.p1.applyBoostDir(-1,0);
    if(e.key==='d'||e.key==='D') game.p1.applyBoostDir( 1,0);
    keys.add(e.key);
    if(e.key==='r'||e.key==='R') startRound();
  });
  addEventListener('keyup',e=>{ keys.delete(e.key); });

  // M√≥vil
  hud.btnL.addEventListener('touchstart',e=>{e.preventDefault(); game.p1.applyBoostDir(-1,0);});
  hud.btnR.addEventListener('touchstart',e=>{e.preventDefault(); game.p1.applyBoostDir( 1,0);});
  hud.btnP.addEventListener('touchstart',e=>{e.preventDefault(); if(game.phase==='window' && game.p1.launching) game.p1.fairLaunch(game.angle1); });

  // Lanzamiento justo
  function triggerFairLaunchP1(){ if(game.phase==='window' && game.p1.launching) game.p1.fairLaunch(game.angle1); }
  function triggerFairLaunchP2(){ if(game.phase==='window' && game.p2.launching) game.p2.fairLaunch(game.angle2); }

  function cpuPlanWindow(){
    if(game.twoPlayers) return;
    const t = 0.35 + Math.random()*1.2;
    setTimeout(()=>{ if(game.phase==='window' && game.p2.launching){ game.p2.fairLaunch(game.angle2 + (Math.random()*0.5-0.25)); } }, t*1000);
  }

  function collide(a,b){
    if(!a.hasLaunched || !b.hasLaunched) return;
    const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), minD=a.radius+b.radius;
    if(d<=0||d>minD) return;
    const nx=dx/d, ny=dy/d, overlap=minD-d;
    a.x-=nx*overlap*0.5; a.y-=ny*overlap*0.5; b.x+=nx*overlap*0.5; b.y+=ny*overlap*0.5;
    const va=a.vx*nx+a.vy*ny, vb=b.vx*nx+b.vy*ny, m1=a.mass, m2=b.mass, k=0.9;
    const va2=(va*(m1-m2)+2*m2*vb)/(m1+m2), vb2=(vb*(m2-m1)+2*m1*va)/(m1+m2);
    a.vx+=(va2-va)*nx*k; a.vy+=(va2-va)*ny*k; b.vx+=(vb2-vb)*nx*k; b.vy+=(vb2-vb)*ny*k;

    const rel=Math.abs(va-vb), baseRPM=60+35*rel, baseHP=10+6*rel;
    let lossA = baseRPM * (b.dmg>0?1.4:1) * (a.shield>0?0.5:1);
    let lossB = baseRPM * (a.dmg>0?1.4:1) * (b.shield>0?0.5:1);
    a.spinRPM=Math.max(0,a.spinRPM-lossA); b.spinRPM=Math.max(0,b.spinRPM-lossB);
    let hpA = baseHP * (b.dmg>0?1.3:1) * (a.shield>0?0.6:1);
    let hpB = baseHP * (a.dmg>0?1.3:1) * (b.shield>0?0.6:1);
    a.takeDamage(hpA); b.takeDamage(hpB);

    spawnSparks((a.x+b.x)/2,(a.y+b.y)/2, 22, Math.floor(Math.random()*360));
  }

  function drawArena(){
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.translate(arena.cx,arena.cy);
    for(let i=6;i>=1;i--){
      const r=arena.r*(i/6);
      ctx.beginPath(); ctx.arc(0,0,r,0,TAU);
      const g=ctx.createRadialGradient(0,0,r*0.2,0,0,r);
      g.addColorStop(0,'#0c1120'); g.addColorStop(1,'#080b12');
      ctx.fillStyle=g; ctx.fill();
      ctx.strokeStyle = i%2 ? 'rgba(0,231,255,.30)' : 'rgba(138,43,255,.26)';
      ctx.lineWidth = i===6? 6 : 4;
      if(i===5) ctx.setLineDash([10,10]); else ctx.setLineDash([]);
      ctx.shadowColor = i%2? 'rgba(0,231,255,.45)' : 'rgba(138,43,255,.4)';
      ctx.shadowBlur=8; ctx.stroke(); ctx.shadowBlur=0;
    }
    ctx.beginPath(); ctx.arc(0,0,arena.innerR,0,TAU); ctx.setLineDash([8,10]);
    ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  }

  function drawAim(b,angle,charge,col){
    ctx.save(); ctx.strokeStyle=col; ctx.globalAlpha=.9; ctx.lineWidth=4; ctx.shadowColor=col; ctx.shadowBlur=10;
    ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.x+Math.cos(angle)*(120+90*charge), b.y+Math.sin(angle)*(120+90*charge)); ctx.stroke(); ctx.restore();
  }

  // Loop
  let last=0;
  function loop(t){
    const dt=Math.min(0.033,(t-last||16)/1000); last=t;

    drawArena();

    // Spawner de √≠tems
    game.spawnTimer-=dt; if(game.spawnTimer<=0){ spawnItem(); game.spawnTimer=rand(6,9); }

    // CPU boost aleatorio cada 3s
    if(game.phase==='battle' && !game.twoPlayers){
      game.cpuBoostTimer-=dt;
      if(game.cpuBoostTimer<=0){
        const ang = rand(0,TAU);
        game.p2.applyBoostDir(Math.cos(ang), Math.sin(ang));
        game.cpuBoostTimer=3.0;
      }
    }

    // Fases
    if(game.phase==='countdown'){
      if(keys.has('a')||keys.has('A')||keys.has('ArrowLeft')) game.angle1 -= 0.05;
      if(keys.has('d')||keys.has('D')||keys.has('ArrowRight')) game.angle1 += 0.05;
      if(game.twoPlayers){
        if(keys.has('ArrowLeft')) game.angle2 -= 0.05;
        if(keys.has('ArrowRight'))game.angle2 += 0.05;
      }
      game.countdownLeft-=dt;
      const whole=Math.ceil(game.countdownLeft);
      if(game.countdownLeft>0){ showOverlay(String(whole),'prep√°rate‚Ä¶'); }
      else{ game.phase='window'; game.windowLeft=2.0; showOverlay('GO!','tienes 2.0s para lanzar'); cpuPlanWindow(); }
    }
    else if(game.phase==='window'){
      if(keys.has(' ')) triggerFairLaunchP1();
      if(game.twoPlayers && keys.has('Shift')) triggerFairLaunchP2();
      game.windowLeft-=dt; hud.countSmall.textContent=`tienes ${Math.max(0,game.windowLeft).toFixed(1)}s para lanzar`;
      if(game.windowLeft<=0){
        if(!game.p1.hasLaunched) game.p1.alive=false;
        if(!game.p2.hasLaunched) game.p2.alive=false;
        hideOverlay(); game.phase='battle';
      }
    }
    else if(game.phase==='battle'){
      game.p1.step(dt); game.p2.step(dt);
      collide(game.p1,game.p2);
      tryPickup(game.p1); tryPickup(game.p2);
      if(!game.p1.alive || !game.p2.alive){ game.running=false; game.phase='menu'; showMenu(true); }
    }

    // UI y dibujo
    if(game.p1.launching && (game.phase==='countdown'||game.phase==='window')) drawAim(game.p1,game.angle1,0,'#33d6ff');
    if(game.p2.launching && (game.phase==='countdown'||game.phase==='window')) drawAim(game.p2,game.angle2,0,'#ff6b6b');

    drawItems(dt);
    game.p1.draw(); game.p2.draw();
    drawSparks(dt); stepToast(dt);

    hud.m1.style.width=(game.p1.hp/game.p1.maxHP*100).toFixed(0)+'%';
    hud.m2.style.width=(game.p2.hp/game.p2.maxHP*100).toFixed(0)+'%';
    hud.hp1.textContent='HP '+Math.max(0,Math.round(game.p1.hp));
    hud.hp2.textContent='HP '+Math.max(0,Math.round(game.p2.hp));
    hud.boost1.textContent = game.p1.boostCD>0 ? `Boost: ${game.p1.boostCD.toFixed(2)}s` : 'Boost: listo';
    hud.boost2.textContent = game.p2.boostCD>0 ? `Boost: ${game.p2.boostCD.toFixed(2)}s` : 'Boost: listo';

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // init
  setupArena(); resetPositions(); showMenu(true);
})();
</script>
</body>
</html>
